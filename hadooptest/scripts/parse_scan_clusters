#!/usr/bin/env perl

use strict;
use warnings;
use FindBin qw($Bin $Script);
use Test::More;
use File::Copy;
use File::Find::Rule;
use File::Basename;

my $line;
my $fs_used_percentage;
my $fs_used_threshold=90;
my $df_header;
my $show_df_header=1;
my $show_cluster_header=1;
my $cluster;
my $prev_hostname="";
my $hostname;
my $version;
my $time;
my $webui;
my $webui_cluster;
my $webui_comp;

#################################################################################
# Reports to output
#################################################################################
my $output_dir="$Bin/../target";
mkdir $output_dir unless (-d $output_dir);
my $cluster_usage_report="$output_dir/cluster_usage.log";
my $issues_report="$output_dir/cluster_issues.log";
my $webui_report="$output_dir/webui.html";

my $tmpfile="/tmp/clusterinfo.raw";
system("rm -f $tmpfile");

open(my $fh_issues, '>', $issues_report) or die "Could not open file '$issues_report' $!";
open(my $fh_webui, '>', $webui_report) or die "Could not open file '$webui_report' $!";
print $fh_webui "<Pre>\n";
chomp(my $ts=`date -u +%Y%m%d-%H%M%S`);
print $fh_webui "This page is auto-generated on ${ts}, with rolesdb roles from http://roles.corp.yahoo.com:9999/ui/role?action=list&role=grid_re.clusters\n";

sub print_cluster_header() {
    print("--------------------\n");
    print("cluster=$cluster\n");
    print("--------------------\n");

    print $fh_issues "--------------------\n";
    print $fh_issues "cluster=$cluster\n";
    print $fh_issues "--------------------\n";

    $show_cluster_header=0;
}

sub print_df_header() {
    print($df_header);
    print $fh_issues $df_header;
    $show_df_header=0;
}

#################################################################################
# Parse the input file
# open call is not needed when opening the file specified as the first argument
# open(FILE1, $ARGV[0]);
#################################################################################
while (<>) {
    # $. keep track of the current line number
    # printf("line %2d: %s", $., $_);

    $line = $_;

    if (($line =~ /^\Q+\E/) || 
        ($line =~ "Warning: Permanently added") ||
        ($line =~ "---------")) {
        next;
    }

    # Save the cluster header
    if ($line =~ m/(^cluster)\s+(.*)/) {
        $cluster = $2;
	system("echo -n \"$cluster, \" >> $tmpfile");
        $show_cluster_header=1;
        $show_df_header=1;
        next;
    }

    # Save the df header
    if ($line =~ /(.*)\s+(Filesystem)\s+(.*)/) {
        $df_header = $line;
        next;
    }

    $version="UNKNOWN";
    $time="UNKNOWN";

    if ($line =~ m/(^Hadoop.*:)\s+(.*)/) {
        $version = $2;
	system("echo -n \"$version, \" >> $tmpfile");
        next;
    }

    if ($line =~ m/(^Time.*:)\s+(.*)/) {
        $time = $2;
	system("echo -n \"$time, \" >> $tmpfile");
	system("echo `date -d $time +%s` >> $tmpfile");
        next;
    }

    if ($line =~ m/(^WEBUI.*:)\s+(.*)\s+(.*)\s+(http.*)/) {
        $webui_cluster=$2;
        $webui_comp=$3;
        $webui = $4;
        printf $fh_webui "%-12s %s %s %s\n", "$webui_cluster", "$webui_comp", "-", "<a href=$webui>$webui</a>";
        next;
    }

    # Check percentage
    if ($line =~ m/(.*)\s+(\d+)(%)\s+(.*)/) {
        $$fs_used_percentage=$2;
        if ($$fs_used_percentage > $fs_used_threshold) {
            print_cluster_header() if ($show_cluster_header == 1);
            print_df_header() if ($show_df_header == 1);
            print($line);
            print $fh_issues $line;
        }
    } else {
        if ($line =~ "/vol/") {
            next;
        }
        print_cluster_header() if ($show_cluster_header == 1);
        printf("%s", $line);
        print $fh_issues $line;

        # Attempt to reboot the node
        if (($_ =~ m/(.*)\s+(gsbl.*)(:.*)/) || 
            ($_ =~ m/(.*)\s+(gsta.*)(:.*)/) ||
            ($_ =~ m/(.*)\s+(.*.ygrid.yahoo.com)\s+(.*)/) ) {
            $hostname = $2;
            unless ($hostname =~ $prev_hostname) {
                # reboot the node
                print("ssh adm102.blue.ygrid.yahoo.com sudo -u hadoopqa /home/y/bin/flubber_conutil -m reboot $hostname\n");
                print $fh_issues "ssh adm102.blue.ygrid.yahoo.com sudo -u hadoopqa /home/y/bin/flubber_conutil -m reboot $hostname\n";

                # system("ssh adm102.blue.ygrid.yahoo.com sudo -u hadoopqa /home/y/bin/flubber_conutil -m reboot $hostname");
                # Sorry, user hadoopqa is not allowed to execute '/home/y/bin/flubber_conutil -m reboot dense28.blue.ygrid.yahoo.com' as hadoopqa on adm102.blue.ygrid.yahoo.com.

                # bash-4.1$ ssh adm102.blue.ygrid.yahoo.com SUDO_USER=hadoopqa /home/y/bin/flubber_conutil -m reboot dense28.blue.ygrid.yahoo.com
                # User : hadoopqa does not have the required permissions. at /home/y/bin/flubber_conutil line 39.
            }
            $prev_hostname = $hostname;
        }       
    }
}
close $fh_issues;

print $fh_webui "<Pre>\n";
close $fh_webui;

#################################################################################
# Write the cluster usage report
#################################################################################
open(my $fh, '>', $cluster_usage_report) or die "Could not open file '$cluster_usage_report' $!";
print $fh "-------------------------------------------\n";
print $fh "cluster, version, time of last job\n";
print $fh "-------------------------------------------\n";
close $fh;
system("sort -k4 $tmpfile|cut -d, -f1-3 >> $cluster_usage_report");
system("cat $cluster_usage_report");

