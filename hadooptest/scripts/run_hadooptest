#!/bin/bash

function usage {
    echo 
    echo "USAGE"
    echo "-----------------------------------------------------------------------------------"
    echo "/bin/sh $0 <option1> <values1> <option2> <values2> ...
The options
        -c|--cluster    <cluster name> : cluster name
        [ -w|workspace  <workspace>        ] : workspace
        [ -n|--nopasswd                    ] : no password prompt
        [ -j|--java                        ] : run tests via java directly instead of via maven
        [ -m|--mvn                         ] : run tests via maven instead of via java directly
        [ -t|--test      <test suite(s)    ] : test suite name(s). use delimitor comma for mvn, and space for java
        [ -h|--help                        ] : help

Example:
$ run_hadooptest --cluster theoden
$ run_hadooptest --cluster theoden --test SleepJobRunner
$ run_hadooptest --cluster theoden --mvn --test SleepJobRunner
$ run_hadooptest -c theoden -t hadooptest.regression.CheckVersion -n
"
    exit 1
}

PASSWORD_OPTION=${PASSWORD_OPTION:-"-password"}
WORKSPACE=${WORKSPACE:="/home/y/etc/hadooptest/java/lib"}

for arg; do 
    [[ "${arg:0:1}" == "-" ]] && delim="" || delim="\""
    if [ "${arg:0:2}" == "--" ]; 
       then args="${args} -${arg:2:1}" 
       else args="${args} ${delim}${arg}${delim}"
    fi
done

# reset the incoming args
eval set -- $args

USE_MVN=1
while getopts "c:w:t:njmh" opt; do
	case $opt in
		c) CLUSTER=$OPTARG;;
		w) WORKSPACE=$OPTARG;;		
		t) TESTS=$OPTARG;;
		n) PASSWORD_OPTION="no-password";;
        j) USE_MVN=0;;
        m) USE_MVN=1;;
		h) usage;;
		*) usage;;
	esac
done

if [ -z $CLUSTER ]; then
   echo "ERROR: Required CLUSTER value not defined!!!";
   exit 1;
fi

DEFAULT_TESTS="\
hadooptest.regression.CheckVersion,\
hadooptest.regression.ChangeConf,\
hadooptest.regression.RestartCluster,\
hadooptest.regression.yarn.SleepJobRunner\
"
# TESTS=${TESTS:="$DEFAULT_TESTS"}

# Setup Hadoop Env Variables (e.g. HADOOP_COMMON_HOME, HADOOP_CONF_DIR, etc

CLASSPATH="\
/home/y/lib/jars/junit.jar:\
/home/gs/gridre/yroot.$CLUSTER/conf/hadoop/:"

if [ "$USE_MVN" -eq 0 ]; then
    CLASSPATH="$CLASSPATH:\
$WORKSPACE/hadooptest-1.0-SNAPSHOT.jar:\
$WORKSPACE/hadooptest-1.0-SNAPSHOT-tests.jar"
fi

HADOOP_INSTALL="/home/gs/gridre/yroot.$CLUSTER"
HADOOP_JAR_PATHS="
$HADOOP_INSTALL/share/hadoop/share/hadoop/common/lib \
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/common \
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/common/lib \
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/hdfs \
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/hdfs/lib \
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/yarn \
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/yarn/lib \
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/mapreduce \ 
$HADOOP_INSTALL/share/hadoop-*/share/hadoop/hdfs
"

for i in $HADOOP_JAR_PATHS
do
  CLASSPATH=${CLASSPATH}:`echo -en ${i}`/*
done
echo "CLASSPATH=$CLASSPATH"

# TODO: long term this should move into the java test framework
if [ "$PASSWORD_OPTION" != 'no-password' ]; then 
   USER=`whoami`
   if [ $USER == 'hadoopqa' ];then
      echo "Headless user 'hadoopqa' requires no password."
   else 
      stty -echo
      /usr/kerberos/bin/kinit $USER@DS.CORP.YAHOO.COM
      stty echo
   fi
fi

if [ -n $TESTS ]; then
	TESTS_OPT="-Dtest=$TESTS"
else 
	TESTS_OPT=""
fi

if [ "$USE_MVN" -eq 1 ]; then
    set -x
    CLUSTER=$CLUSTER \
HADOOP_VERSION=`ls -l /home/gs/gridre/yroot.${CLUSTER}/share/hadoop|cut -d">" -f2|cut -d"-" -f2` \
HADOOP_SHARE=/grid/0/gshome/gridre/yroot.${CLUSTER}/share/hadoop-${HADOOP_VERSION}/share/hadoop/ \
/home/y/bin/mvn -f pom-ci.xml clean test -DfailIfNoTests=false $TESTS_OPT
    set +x
else
    # /home/y/bin/mvn clean package -Pdist -Dtar
    set -x
    /home/y/bin/java -cp $CLASSPATH org.junit.runner.JUnitCore $TESTS
    set +x
fi
