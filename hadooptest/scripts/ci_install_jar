#!/bin/bash

echo WORKSPACE=$WORKSPACE

# need OS version, if rhel7 we have to use test branch pkgs
OS_VER=`cat /etc/redhat-release | cut -d' ' -f7`
if [[ ! "$OS_VER" =~ "6." ]] && [[ ! "$OS_VER" =~ "7." ]]; then 
  echo "Error: OS version is empty or unknown, OS_VER: $OS_VER"
else
  echo "INFO: Our OS version is $OS_VER"
fi

set -x

# yjava_byauth
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch" ]
then
   if [[ "$OS_VER" =~ "7." ]]; then
     /usr/local/bin/yinst fetch -br test yjava_byauth -outputfile $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/yjava_byauth.tgz
   else
     /usr/local/bin/yinst fetch yjava_byauth -outputfile $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/yjava_byauth.tgz
   fi

   gunzip -f $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/yjava_byauth.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/yjava_byauth.tar -C $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/
fi

# yjava_jetty-9.1.4.v20140401_65
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch" ]
then
   /usr/local/bin/yinst fetch yjava_jetty-9.1.4.v20140401_65 -br current -outputfile $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/yjava_jetty.tgz
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/yjava_jetty.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/yjava_jetty.tar -C $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/
fi

# yspark_yarn
# allow specifying version if sparkversion parameter used.
# sparkversion <version number> <optional branch>
if [ "$1" == "sparkversion" ]
then
  BRANCH="-br current"
  rm -rf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch
  if [[ -z "$2" ]]; then
    echo "ERROR you must set a spark version"
    exit 1
  fi
  if [[ -n "$3" ]]; then
    BRANCH="-br $3"
  fi
  /usr/local/bin/yinst fetch yspark_yarn-$2 $BRANCH -outputfile $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
  gunzip -f $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
  tar -xf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tar -C $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/
elif [ "$1" == "spark14" ]
then
  rm -rf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch
  /usr/local/bin/yinst fetch yspark_yarn-1.4.0.0_2.6.0.16.1506060127_1506241920 -outputfile $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz 
  gunzip -f $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
  tar -xf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tar -C $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/
elif [ "$1" == "spark15" ]
then
  rm -rf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch
  /usr/local/bin/yinst fetch yspark_yarn-1.5.1.0_2.6.0.16.1506060127_1509251420 -outputfile $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz 
  gunzip -f $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
  tar -xf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tar -C $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/
else
  if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/share/spark-1.6.2.0_2.8.0.1.1608041516_1608052051" ]
  then
  rm -rf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch
  /usr/local/bin/yinst fetch yspark_yarn-1.6.2.0_2.8.0.1.1608041516_1608052051 -outputfile $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz -br quarantine
  gunzip -f $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
  tar -xf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tar -C $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/
  fi
fi

# hbase
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/hbase_fetch" ]
then
   if [[ "$OS_VER" =~ "7." ]]; then
     hbase_version=$( /usr/local/bin/yinst packages -br test hbase | awk '{print $1}' )
   else
     hbase_version=$( /usr/local/bin/yinst packages hbase | awk '{print $1}' )
   fi

   /usr/local/bin/yinst fetch ${hbase_version} -outputfile $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/hbase.tgz -br quarantine -br nightly -br test
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/hbase.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/hbase.tar -C $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/
fi
