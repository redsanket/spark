#!/bin/bash

echo WORKSPACE=$WORKSPACE

set -x

# yjava_byauth
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch" ]
then
   /usr/local/bin/yinst fetch yjava_byauth -outputfile $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/yjava_byauth.tgz
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/yjava_byauth.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/yjava_byauth.tar -C $WORKSPACE/yinst_fetch_dependencies/yjava_byauth_fetch/
fi

# yjava_jetty-9.1.4.v20140401_65
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch" ]
then
   /usr/local/bin/yinst fetch yjava_jetty-9.1.4.v20140401_65 -br current -outputfile $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/yjava_jetty.tgz
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/yjava_jetty.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/yjava_jetty.tar -C $WORKSPACE/yinst_fetch_dependencies/yjava_jetty_fetch/
fi

# yspark_yarn
if [ "$1" == "spark12hadoop26" ]
then
   if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/share/spark-1.2.0.0_2.6.0.1.1411101121_1412171547" ]
   then
      rm -rf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch
      /usr/local/bin/yinst fetch yspark_yarn-1.2.0.0_2.6.0.1.1411101121_1412171547 -outputfile $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
      gunzip -f $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
      tar -xf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tar -C $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/
   fi
else
   if [ "$1" == "spark12" ]
   then
     if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/share/spark-1.2.0.0_2.5.0.8.1411070359_1412171833" ]
     then
        rm -rf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch
        /usr/local/bin/yinst fetch yspark_yarn-1.2.0.0_2.5.0.8.1411070359_1412171833 -outputfile $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
        gunzip -f $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
        tar -xf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tar -C $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/
     fi
   else
     if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/share/spark-1.2.0.0_2.6.0.1.1411101121_1412171547" ]
     then
        rm -rf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch
        /usr/local/bin/yinst fetch yspark_yarn-1.2.0.0_2.6.0.1.1411101121_1412171547 -outputfile $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
        gunzip -f $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tgz
        tar -xf $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/yspark_yarn.tar -C $WORKSPACE/yinst_fetch_dependencies/yspark_yarn_fetch/
     fi
  fi
fi

# ystorm_contrib
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/ystorm_contrib_fetch" ]
then
   ystorm_contrib_version=$( /usr/local/bin/yinst packages -latest ystorm_contrib | awk '{print $1}' )
   /usr/local/bin/yinst fetch ${ystorm_contrib_version} -outputfile $WORKSPACE/yinst_fetch_dependencies/ystorm_contrib_fetch/ystorm_contrib.tgz -br quarantine -br nightly -br test
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/ystorm_contrib_fetch/ystorm_contrib.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/ystorm_contrib_fetch/ystorm_contrib.tar -C $WORKSPACE/yinst_fetch_dependencies/ystorm_contrib_fetch/
fi

# hbase
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/hbase_fetch" ]
then
   hbase_version=$( /usr/local/bin/yinst packages -latest hbase | awk '{print $1}' )
   /usr/local/bin/yinst fetch ${hbase_version} -outputfile $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/hbase.tgz -br quarantine -br nightly -br test
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/hbase.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/hbase.tar -C $WORKSPACE/yinst_fetch_dependencies/hbase_fetch/
fi

# ystorm
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/ystorm_fetch" ]
then
   ystorm_version=$( /usr/local/bin/yinst packages -latest ystorm | awk '{print $1}' )
   /usr/local/bin/yinst fetch ${ystorm_version} -outputfile $WORKSPACE/yinst_fetch_dependencies/ystorm_fetch/ystorm.tgz -br quarantine -br nightly -br test
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/ystorm_fetch/ystorm.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/ystorm_fetch/ystorm.tar -C $WORKSPACE/yinst_fetch_dependencies/ystorm_fetch/
fi

# ytez
if [ ! -d "$WORKSPACE/yinst_fetch_dependencies/ytez_fetch" ]
then
   yinst i dist_tools
   just_tez_version_num=$( dist_tag list TEZ_0_6_LATEST | grep ytez_full | cut -c11-28 )
   ytez_version="ytez-"$just_tez_version_num
   #ytez_version=$( /usr/local/bin/yinst packages ytez -br test  | awk '{print $1}' )
   #just_tez_version_num=$( echo "$ytez_version"|cut -d'-' -f2 )
   /usr/local/bin/yinst fetch ${ytez_version} -outputfile $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/ytez.tgz -br quarantine -br nightly -br test
   gunzip -f $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/ytez.tgz
   tar -xf $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/ytez.tar -C $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/
   #Create links so that we do not need to specify versions in the pom
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-api-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-api.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-common-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-common.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-dag-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-dag.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-examples-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-examples.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-mapreduce-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-mapreduce.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-yarn-timeline-history-with-acls-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-yarn-timeline-history-with-acls.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-runtime-internals-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-runtime-internals.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-runtime-library-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-runtime-library.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-tests-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-tests.jar
   ln -s $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-mbeans-resource-calculator-${just_tez_version_num}.jar $WORKSPACE/yinst_fetch_dependencies/ytez_fetch/libexec/tez/tez-mbeans-resource-calculator.jar

fi
