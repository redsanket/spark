#!/bin/bash

function usage {
    echo
    echo "USAGE"
    echo "-----------------------------------------------------------------------------------"
    echo "/bin/sh $0 <option1> <values1> <option2> <values2> ...
The options
        -c|--cluster <cluster name>          : cluster name
        [ -s|--source    <source root dir> ] : source root directory
        [ -g|--gateway   <aateway>         ] : remote gateway host
        [ -w|--workspace <workspace>       ] : remote workspace
        [ -u|--user      <remote user>     ] : remote user; e.g. hadoopqa
        [ -n|--nopasswd                    ] : no password prompt
        [ -j|--java                        ] : run tests via java directly instead of via maven
        [ -m|--mvn                         ] : run tests via maven instead of via java directly
        [ -i|--install                     ] : transport packages to remote host only
        [ -t|--test      <test suite(s)    ] : test suite name(s)
        [ -h|--help                        ] : help

Example:
$ run_hadooptest_remote --cluster theoden --gateway gwbl2003.blue.ygrid.yahoo.com --install
$ run_hadooptest_remote --cluster theoden --gateway gwbl2003.blue.ygrid.yahoo.com --mvn --install
$ run_hadooptest_remote --cluster theoden --java --install
$ run_hadooptest_remote --cluster theoden --mvn --install -u hadoopqa
$ run_hadooptest_remote --cluster theoden --mvn --workspace /tmp/foo --install -u hadoopqa
$ run_hadooptest_remote --cluster theoden --gateway gwbl2003.blue.ygrid.yahoo.com --mvn --test SleepJobRunner
$ run_hadooptest_remote -c theoden -g gwbl2003.blue.ygrid.yahoo.com -i
$ run_hadooptest_remote -c theoden -g gwbl2003.blue.ygrid.yahoo.com -n
$ run_hadooptest_remote -c theoden -g gwbl2005.blue.ygrid.yahoo.com -s /home/hadoopqa/git/hadooptest/hadooptest -i
"
    exit 1
}

for arg; do 
    [[ "${arg:0:1}" == "-" ]] && delim="" || delim="\""
    if [ "${arg:0:2}" == "--" ]; 
       then args="${args} -${arg:2:1}" 
       else args="${args} ${delim}${arg}${delim}"
    fi
done

# reset the incoming args
eval set -- $args

INSTALL_ONLY=0
USE_MVN=1
while getopts "c:g:s:t:u:w:njmih" opt; do
        case $opt in
                c) CLUSTER=$OPTARG;;
                g) REMOTE_HOST=$OPTARG;;
                s) LOCAL_WORKSPACE=$OPTARG;;
                t) TESTS=$OPTARG;;
                u) REMOTE_USER=$OPTARG;;
                w) REMOTE_WORKSPACE=$OPTARG;;
                n) PASSWORD_OPTION="-n";;
                i) INSTALL_ONLY=1;;
                j) USE_MVN=0;;
                m) USE_MVN=1;;
                h) usage;;
                *) usage;;
        esac
done

if [ -z $CLUSTER ]; then
   echo "ERROR: Required CLUSTER value not defined!!!";
   exit 1;
fi

DEFAULT_REMOTE_HOST="gwbl2005.blue.ygrid.yahoo.com"
if [ -z $REMOTE_HOST ]; then
   echo "WARN: gateway not specified: using default gateway $DEFAULT_REMOTE_HOST.";
fi
REMOTE_HOST=${REMOTE_HOST:=$DEFAULT_REMOTE_HOST}

USER=`whoami`
REMOTE_USER=${REMOTE_USER:=`whoami`}
REMOTE_WORKSPACE=${REMOTE_WORKSPACE:="/tmp/$REMOTE_USER-hadooptest"}

if [ "$REMOTE_USER" == "hadoopqa" ]; then
# 	ssh -t $REMOTE_HOST "sudo rm -rf $REMOTE_WORKSPACE;";
	set -x
	ssh -t $REMOTE_HOST "if [ -d $REMOTE_WORKSPACE ]; then sudo /bin/rm -rf $REMOTE_WORKSPACE; fi";
	set +x
else
	set -x
	ssh -t $REMOTE_HOST "if [ -d $REMOTE_WORKSPACE ]; then /bin/rm -rf $REMOTE_WORKSPACE; fi";
	set +x
fi

set -x
ssh -t $REMOTE_HOST "/bin/mkdir -p $REMOTE_WORKSPACE";
set +x

LOCAL_WORKSPACE=${WORKSPACE:="/Users/$USER/git/hadooptest/hadooptest"}
LOCAL_WORKSPACE_TARGET_DIR="$LOCAL_WORKSPACE/target"

echo "CLUSTER='$CLUSTER'"
echo "LOCAL_WORKSPACE='$LOCAL_WORKSPACE'"
echo "REMOTE_HOST='$REMOTE_HOST'"
echo "REMOTE_WORKSPACE='$REMOTE_WORKSPACE'"
echo "TESTS='$TESTS'"
echo "USE_MVN='$USE_MVN'"
echo "INSTALL_ONLY='$INSTALL_ONLY'"

TGZ_DIR=/tmp
TGZ_FILE=hadooptest.tgz

set -x
tar -zcf $TGZ_DIR/$TGZ_FILE --exclude='target' -C $LOCAL_WORKSPACE .
scp $TGZ_DIR/$TGZ_FILE $REMOTE_HOST:$REMOTE_WORKSPACE
ssh -t $REMOTE_HOST "/bin/gtar fx $REMOTE_WORKSPACE/$TGZ_FILE -C $REMOTE_WORKSPACE";
set +x

#if [ "$USE_MVN" -eq 1 ]; then
#   set -x
#   tar -zcf $TGZ_DIR/$TGZ_FILE --exclude='target' -C $LOCAL_WORKSPACE .
#   scp $TGZ_DIR/$TGZ_FILE $REMOTE_HOST:$REMOTE_WORKSPACE
#   ssh -t $REMOTE_HOST "/bin/gtar fx $REMOTE_WORKSPACE/$TGZ_FILE -C $REMOTE_WORKSPACE";
#   set +x
#else 
if [ "$USE_MVN" -ne 1 ]; then
     set -x
     scp $LOCAL_WORKSPACE_TARGET_DIR/*.jar $REMOTE_HOST:$REMOTE_WORKSPACE
     # scp $LOCAL_WORKSPACE/scripts/run_hadooptest $REMOTE_HOST:$REMOTE_WORKSPACE
     set +x
fi

if [ -z $TESTS ]
then
    TESTS_PARAM=""
else
    TESTS_PARAM="--test $TESTS"
fi

if [ "$REMOTE_USER" == "hadoopqa" ]; then
	ssh -t $REMOTE_HOST "sudo chown -R hadoopqa $REMOTE_WORKSPACE;";
fi

if [ "$INSTALL_ONLY" -ne 1 ]; then
   if [ "$USE_MVN" -eq 1 ]; then
      set -x
      ssh -t $REMOTE_HOST "cd $REMOTE_WORKSPACE; $REMOTE_WORKSPACE/scripts/run_hadooptest --cluster $CLUSTER --mvn $PASSWORD_OPTION $TESTS_PARAM";
      # copy the test results back
      scp -r $REMOTE_HOST:$REMOTE_WORKSPACE/target/surefire-reports $LOCAL_WORKSPACE_TARGET_DIR/
      set +x
   else 
      set -x
      ssh -t $REMOTE_HOST "$REMOTE_WORKSPACE/run_hadooptest --c $CLUSTER --workspace $REMOTE_WORKSPACE $PASSWORD_OPTION $TESTS_PARAM";
   set +x
   fi
fi
